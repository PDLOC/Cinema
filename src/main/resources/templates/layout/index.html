<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:fragment="dynamic(main)">

<head>
<meta charset="UTF-8">
<title>Universe</title>
<link rel="shortcut icon" href="/assets/Images/2.png "
	type="image/x-icon">

<!-- Font  -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link
	href="https://fonts.googleapis.com/css2?family=Ubuntu&display=swap"
	rel="stylesheet">

<!-- FontAweSome -->
<script src="https://kit.fontawesome.com/f41adfc48f.js"
	crossorigin="anonymous"></script>

<!-- Bootstrap CSS -->
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css"
	rel="stylesheet"
	integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x"
	crossorigin="anonymous">
<link href="/assets/statics/style.css" rel="stylesheet" type="text/css" />
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
	integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w=="
	crossorigin="anonymous" referrerpolicy="no-referrer" />
<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<link rel="stylesheet" href="/assets/statics/bootstrap.min.css">
<link rel="stylesheet" href="/assets/statics/style-min.css">
<link rel="stylesheet" href="/assets/css/cards.css">
<link rel="stylesheet" href="/assets/css/ghe.css">
<link rel="stylesheet" href="/assets/css/faq.css">
<link rel="stylesheet" href="/assets/css/login.css">
<link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
	integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
	crossorigin="anonymous"></script>
<script
	src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"
	integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
	crossorigin="anonymous"></script>
<script
	src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"
	integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
	crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script
	src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.15/dist/sweetalert2.min.js"></script>
</head>
<style>
#scrollToTopButton {
	position: fixed;
	bottom: 40px;
	right: 25px;
	font-size: 25px;
	z-index: 99;
	width: 50px;
	height: 50px;
	background-color: red;
	color: black;
	border: none;
	cursor: pointer;
	outline: none;
	padding: 6px;
	border-radius: 50%;
}

#scrollToTopButton:hover, i:hover {
	background-color: white;
	color: red;
}

/* Ẩn nút tăng giảm của input kiểu số */
input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button
	{
	-webkit-appearance: none;
	margin: 0;
}
</style>

<body ng-app="cinema-app" ng-controller="cinema-ctrl"
	style="background-image: url(/assets/Images/back.jpg); background-size: cover;">
	<div th:replace="/layout/menu.html"></div>
	<article>
		<div th:replace="${main}"></div>
	</article>

	<div th:replace="/layout/footer.html"></div>

	<!----------------------scroll back to top button-->
	<button id="scrollToTopButton" title="Go to top">
		<i class="fa fa-angle-double-up" aria-hidden="true"></i>
	</button>
	<script>
        $(document).ready(function () {
            var scrollTopButton = document.getElementById("scrollToTopButton");
            window.onscroll = function () { scrollFunction() };

            function scrollFunction() {
                if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                    scrollTopButton.style.display = "block";
                } else {
                    scrollTopButton.style.display = "none";
                }
            }

            $("#scrollToTopButton").click(function () {
                $('html ,body').animate({ scrollTop: 0 }, 800)
            });
        });
    </script>

	<!-- footer scripts -->

	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	<script src="http://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
	<script src="https://daniellaharel.com/raindrops/js/raindrops.js"></script>
	<script
		src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
	<script src="/assets/js/main-min.js"></script>
	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/2.1.2/sweetalert.min.js"
		integrity="sha512-AA1Bzp5Q0K1KanKKmvN/4d3IRKVlv9PYgwFPvm32nPO6QS8yH1HO7LbgB1pgiOxPtfeg5zEn2ba64MUcqJx6CA=="
		crossorigin="anonymous" referrerpolicy="no-referrer"></script>

	<script>
        function logout() {
            window.location.replace("login.html");
        }
    </script>

	<script>
        document.addEventListener('scroll', () => {
            const header = document.querySelector('header');
            if (window.scrollY > 0) {
                header.classList.add('scrolled');
            } else {
                header.classList.remove('scrolled');
            }
        })
    </script>

	<!---------------------------- Lịch chiếu trong chi tiết --------------------------------------------->
	<script th:inline="javascript">
        // Lấy tham chiếu đến các phần tử DOM
        var btnOpen = document.getElementById("btnOpen");
        var danhSachNut = document.getElementById("danhSachNut");
        var btnOpen2 = document.getElementsByClassName("btnOpen2");
        var danhSachNut2 = document.getElementById("danhSachNut2");

        // Lắng nghe sự kiện click vào nút bấm
        btnOpen.addEventListener("click", function () {
            // Kiểm tra trạng thái hiển thị của dàn nút
            if (danhSachNut.style.display === "none") {
                // Nếu đang ẩn, hiển thị dàn nút
                danhSachNut.style.display = "block";
            } else {
                // Nếu đang hiển thị, ẩn dàn nút
                danhSachNut.style.display = "none";
            }
        });
        for(var i = 0; i < btnOpen2.length; i++){
        	var a = btnOpen2[i];
        	// Lắng nghe sự kiện click vào nút bấm
        	a.addEventListener("click", function () {
    		 // Lấy giá trị của thuộc tính "ngaychieu" từ phần tử a
            var ngaychieu = this.getAttribute("data-ng");
			var lich = /*[[${listLich2}]]*/'';
			var giobatdauArray = [];
			// Lặp qua mảng lich và hiển thị giờ bắt đầu của mỗi item
		    lich.map(item=> {
		      // Kiểm tra nếu ngày chiếu của item khớp với ngày được chọn
		      var ngaychieuFormatted = formatNgayChieu(item.ngaychieu);
		      if (ngaychieuFormatted === ngaychieu) {
		        giobatdauArray.push(item.giobatdau);
				console.log(item)							
		      }
		    });
		 

			var giobatdauArrayElement = document.getElementById("giobatdauArray");
			var giobatdauContainerElement = document.getElementById("giobatdauContainer");
			//Remove existing buttons
			while (giobatdauContainerElement.firstChild) {
			giobatdauContainerElement.removeChild(giobatdauContainerElement.firstChild);
			}
			
			//Create and add new buttons
			for (var i = 0; i < giobatdauArray.length; i++) {
			var giobatdau = giobatdauArray[i];
			
			var buttonElement = document.createElement("button");
			buttonElement.type = "button";
			buttonElement.className = "btn btn-outline-danger mb-2 text-white";
			buttonElement.style.borderRadius = "12px";
			buttonElement.style.width = "140px";
			buttonElement.style.height = "60px";
			buttonElement.style.fontSize = "15px";
			buttonElement.textContent = formatGiobatdau(giobatdau);
			
			var linkElement = document.createElement("a");
			  lich.map(function (item) {
			    if (item.ctphims && item.ctphims.mact && item.giobatdau === giobatdau) {
			      var hrefValue =
			        "/home/booking/ticket/"+item.ctphims.room.mapc+"/"+
			        item.ctphims.mact +
			        "/" +
			        item.formattedGiobatdau;
			      linkElement.setAttribute("href", hrefValue);
			    }
			  });
			linkElement.appendChild(buttonElement);
	
			var divElement = document.createElement("div");
			divElement.className = "cus-sty col-md-2";
			divElement.style.margin = "0.05px";
			divElement.style.display = "inline-block";
			divElement.appendChild(linkElement);
			
			giobatdauContainerElement.appendChild(divElement);
			}
            // Kiểm tra trạng thái hiển thị của dàn nút
            if (danhSachNut2.style.display === "none") {
                // Nếu đang ẩn, hiển thị dàn nút
                danhSachNut2.style.display = "block";
            } else {
                // Nếu đang hiển thị, ẩn dàn nút
                danhSachNut2.style.display = "none";
            }
        });
    }

	     // Hàm để định dạng lại giá trị ngày chiếu
	     function formatNgayChieu(ngaychieu) {
	       var date = new Date(ngaychieu);
	       var day = date.getDate();
	       var month = date.getMonth() + 1;
	       var year = date.getFullYear();
	
	       // Đảm bảo rằng các giá trị ngày và tháng có 2 chữ số
	       if (day < 10) {
	         day = "0" + day;
	       }
	       if (month < 10) {
	         month = "0" + month;
	       }
	
	       return day + "-" + month + "-" + year;
	     }
	     
	  // Hàm để định dạng giá trị giờ bắt đầu thành "HH:mm"
	     function formatGiobatdau(giobatdau) {
	       var date = new Date();
	       var parts = giobatdau.split(":");
	       date.setHours(parts[0]);
	       date.setMinutes(parts[1]);
	       
	       var giobatdauFormatted = date.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' });
	       return giobatdauFormatted;
	     }
    </script>



	<!------------------- data khuyen mai ---------------------------------->
	<script th:inline="javascript">
		let giamgia = 0;
		var makm = 'km00';
		function khuyenMai (){
			var khuyenMaiList = /*[[${itemKM}]]*/'';
			var input = document.getElementById("khuyenMaiInput");
	        var inputValue = input.value;
			khuyenMaiList.map(item =>{
				if (inputValue === item.makm) {
					giamgia = item.giamgia;
					makm = item.makm;
					input.value = "";
				}
			})
			updateSelectedSeats();
		}
	</script>

	<!---------------- Loại ghế ----------------------->
	<script th:inline="javascript">
		var itemLGhe = /*[[${listGhe}]]*/'';
		let vip = 0;
		let regular = 0;
		let couple = 0;
		itemLGhe.map(item =>{
			if (item.loaighe.maloai === 'V') {
				vip = item.loaighe.dongia;
			}
			if (item.loaighe.maloai === 'C') {
				couple = item.loaighe.dongia;
			}
			if (item.loaighe.maloai === 'R') {
				regular = item.loaighe.dongia;
			}
		})
	</script>


	<!---------------------------- Ghế ------------------------------------------>
	<script th:inline="javascript">
    	
		let totalPay = null;
	
    	let itemsArray = [];
    
        let combo = 0;
		const tongGhe = document.getElementById('countSeat')

        var countSeat = [];
		var listGhe = /*[[${listGhe}]]*/'';
        // Lấy danh sách các ghế
        const seats = document.querySelectorAll('.seat');
        const totalSeats = document.getElementById('TotalSeat2');
        
        // Số lượng ghế đã chọn
        let selectedSeats = [];
        let selectedVipSeats = [];
        let selectedRegularSeats = [];
        let selectedCoupleSeats = [];
        let selectedSeatType = null;
        // Giá vé
        const giaVe = document.getElementById('seat-price');
        let regularSeatPrice = 0;
        let vipSeatPrice = 0;
        let coupleSeatPrice = 0;

        /* Quá giờ giảm giá */
        const gioBatDauElement = document.getElementById('GioBatDau');
        const gioBatDau = gioBatDauElement.innerText;
        const gioKetThucElement = document.getElementById('GioKetThuc');
        const gioKetThuc = gioKetThucElement.innerText;

        const gioBatDauHour = parseInt(gioBatDau.split(":")[0]);
        const gioBatDauMinute = parseInt(gioBatDau.split(":")[1]);
        const gioKetThucHour = parseInt(gioKetThuc.split(":")[0]);
        const gioKetThucMinute = parseInt(gioKetThuc.split(":")[1]);

        if ((gioBatDauHour > 21 && gioKetThucHour < 7) ||
            (gioBatDauHour === 21 && gioBatDauMinute > 0) ||
            (gioKetThucHour === 7 && gioKetThucMinute < 59)) {
            regularSeatPrice = regular * 0.9;
            vipSeatPrice = vip * 0.9;
            coupleSeatPrice = couple * 0.9;
        }else{
        	regularSeatPrice = regular;
            vipSeatPrice = vip;
            coupleSeatPrice = couple;
        }

        // Cập nhật số ghế đã chọn và tổng giá vé
        function updateSelectedSeats() {
        	const selected = document.querySelectorAll('.seat.selected');
        	selectedSeats = Array.from(selected).map(seat => seat.getAttribute('data-name'));
        	selectedVipSeats = Array.from(selected).filter(seat => seat.classList.contains('vip'));
        	selectedRegularSeats = Array.from(selected).filter(seat => !seat.classList.contains('vip') && !seat.classList.contains('couple'));
        	selectedCoupleSeats = Array.from(selected).filter(seat => seat.classList.contains('couple'));
        	const selectedSeatsCount = selectedSeats.length;
        	const selectedVipSeatsCount = selectedVipSeats.length;
        	const selectedRegularSeatsCount = selectedRegularSeats.length;
        	const selectedCoupleSeatsCount = selectedCoupleSeats.length;
        	if (selectedSeatsCount > 8) {
        		  alert("Bạn chỉ được chọn tối đa 8 ghế.");

        		  // Bỏ chọn các ghế vượt quá giới hạn
        		  selectedSeats.forEach(seat => {
        		    if (selectedSeats.indexOf(seat.getAttribute('data-name')) > 7) {
        		      const lastClickedSeat = seat.classList.contains('selected') ? seat : null;
					if (lastClickedSeat && !selectedSeats.includes(lastClickedSeat)) {
        		        lastClickedSeat.classList.remove('selected');
        		      }
        		    }
        		  });

        		  // Cập nhật lại mảng selectedSeats
        		  selectedSeats = document.querySelectorAll('.seat.selected');

        		  // Cập nhật lại selectedSeatsCount
        		  selectedSeatsCount = selectedSeats.length;
        		}
            //const totalPrice = selectedSeatsCount * seatPrice;
            //const totalPrice = (selectedVipSeatsCount * vipSeatPrice) + (selectedRegularSeatsCount * regularSeatPrice);
            const totalPrice = (selectedVipSeatsCount * vipSeatPrice) + (selectedRegularSeatsCount * regularSeatPrice) + (selectedCoupleSeatsCount * coupleSeatPrice);
            document.getElementById('selected-seats').textContent = `${selectedSeats.join(', ')}`;
            document.getElementById('total-price').textContent = `${formatNumber(totalPrice + combo)} VND`;
            document.getElementById('combo').textContent = `${formatNumber(combo)} VND`
            tongGhe.textContent = `${selectedSeatsCount}`;
            if(selectedVipSeatsCount >= 1 && selectedRegularSeatsCount === 0 && selectedCoupleSeatsCount === 0){
            	giaVe.textContent = `${vipSeatPrice}`;
            }
            if(selectedVipSeatsCount === 0 && selectedRegularSeatsCount >= 1 && selectedCoupleSeatsCount === 0){
            	giaVe.textContent = `${regularSeatPrice}`;
            }
            if(selectedVipSeatsCount === 0 && selectedRegularSeatsCount === 0 && selectedCoupleSeatsCount >= 1){
            	giaVe.textContent = `${coupleSeatPrice}`;
            }
            
            
            /* payment */
            const nameFlim = document.getElementById("nameFilm").textContent;
            const SuatChieu = document.getElementById("suatChieu").textContent;
            const NgayChieu = document.getElementById("ngayChieu").textContent;
            const RoomCinema = document.getElementById("room").textContent;
            
            document.getElementById('khuyenMai').textContent = `Khuyến mãi: ${giamgia}%`;
            document.getElementById('maKhuyenMai').textContent = `${makm}`;
            document.getElementById('giamGia').textContent = `${giamgia}`;
            document.getElementById('viTriGhePay').textContent = `${selectedSeats.join(', ')}`;
            document.getElementById('nameFlimPay').textContent = `${nameFlim}`;
            document.getElementById('suatChieuPay').textContent = `${SuatChieu}`;
            document.getElementById('ngayChieuPay').textContent = `${NgayChieu}`;
            document.getElementById('roomPay').textContent = `${RoomCinema}`;
            
            document.getElementById("toTalPayNoFormat").textContent = `${totalPrice*(1-(giamgia/100)) + combo}`;
            document.getElementById("toTalPayNoFormat1").textContent = `${formatNumber(totalPrice*(1-(giamgia/100)) + combo)} VND`;
            document.getElementById("toTalPay").textContent = `Tổng Thanh Toán: ${formatNumber(totalPrice*(1-(giamgia/100)))} + ${formatNumber(combo)}`;
            document.getElementById("toTalPay2").textContent = `Thành Tiền: ${formatNumber(totalPrice*(1-(giamgia/100)) + combo)} VND`;
            totalPay = totalPrice*(1-(giamgia/100)) + combo;
            document.getElementById("TotalSeat2").textContent = `Số ghế ${seats.length - selectedSeatsCount}/${listGhe.length}`;
        }
        
        
        function formatNumber(number) {
				return number.toLocaleString('vi-VN').replace(/,/g, '.');
		}

        function selectSeat() {
        	  const isVip = this.classList.contains('vip');
        	  const isCouple = this.classList.contains('couple');

        	  // Kiểm tra xem đã chọn ghế vip hay ghế đôi hay không
        	  const isVipSeatSelected = selectedVipSeats.length > 0;
        	  const isCoupleSeatSelected = selectedCoupleSeats.length > 0;
        	  const isRegularSeatSelected = selectedRegularSeats.length > 0;

        	  // Nếu người dùng chọn ghế vip
        	  if (isVip) {
        	    if (isCoupleSeatSelected || isRegularSeatSelected) {
        	      alert("Chỉ được chọn một loại ghế");
        	      return;
        	    }

        	    // Bỏ chọn tất cả các ghế đôi nếu có
        	    selectedCoupleSeats.forEach(seat => seat.classList.remove('selected'));
        	    selectedCoupleSeats = [];

        	    // Bỏ chọn tất cả các ghế thường nếu có
        	    selectedRegularSeats.forEach(seat => seat.classList.remove('selected'));
        	    selectedRegularSeats = [];

        	    // Thực hiện chọn/ bỏ chọn ghế vip
        	    this.classList.toggle('selected');
        	    if (this.classList.contains('selected')) {
        	      selectedVipSeats.push(this);
        	    } else {
        	      const index = selectedVipSeats.indexOf(this);
        	      if (index > -1) {
        	        selectedVipSeats.splice(index, 1);
        	      }
        	    }
        	    updateSelectedSeats();
        	    return;
        	  }

        	  // Nếu người dùng chọn ghế đôi
        	  if (isCouple) {
        	    if (isVipSeatSelected || isRegularSeatSelected) {
        	      alert("Chỉ được chọn một loại ghế");
        	      return;
        	    }

        	    // Bỏ chọn tất cả các ghế vip nếu có
        	    selectedVipSeats.forEach(seat => seat.classList.remove('selected'));
        	    selectedVipSeats = [];

        	    // Bỏ chọn tất cả các ghế thường nếu có
        	    selectedRegularSeats.forEach(seat => seat.classList.remove('selected'));
        	    selectedRegularSeats = [];

        	    // Thực hiện chọn/ bỏ chọn ghế đôi
        	    this.classList.toggle('selected');
        	    if (this.classList.contains('selected')) {
        	      selectedCoupleSeats.push(this);
        	    } else {
        	      const index = selectedCoupleSeats.indexOf(this);
        	      if (index > -1) {
					selectedCoupleSeats.splice(index, 1);
        	      }
        	    }
        	    updateSelectedSeats();
        	    return;
        	  }

        	  // Nếu người dùng chọn ghế thường
        	  if (isVipSeatSelected || isCoupleSeatSelected) {
        	    alert("Chỉ được chọn một loại ghế");
        	    return;
        	  }

        	  // Thực hiện chọn/ bỏ chọn ghế thường
        	  this.classList.toggle('selected');
        	  if (this.classList.contains('selected')) {
        	    selectedRegularSeats.push(this);
        	  } else {
        	    const index = selectedRegularSeats.indexOf(this);
        	    if (index > -1) {
        	      selectedRegularSeats.splice(index, 1);
        	    }
        	  }
        	  updateSelectedSeats();
        	}

        // Đăng ký sự kiện cho từng ghế
        seats.forEach(seat => {
            seat.addEventListener('click', selectSeat);
        });

        
     // Lưu thông tin vào local session
     function saveBookingInformation() {
    	 	var username = getCookieValue('USERNAME');
    	 	var totalSeat = document.getElementById('countSeat').textContent;
    	 	var movieName = document.getElementById('nameFilm').textContent;
    	 	var timeMovie = document.getElementById('timeShow').textContent;
    	 	var dateMovie = document.getElementById('dateShow').innerHTML;
    	 	var room = document.getElementById('room').textContent;
    	 	var totalAmount = document.getElementById('toTalPayNoFormat').textContent;
    	 	var nameFood = document.getElementById('Food').textContent;
    	 	var imageMovie = document.getElementById('imageMovie').alt;
    	 	var lichSTT = document.getElementById('lichSTT').textContent;
    	 	var iddiscount = document.getElementById('maKhuyenMai').textContent;
    	 	var discount = document.getElementById('giamGia').textContent;
    	 	var seatPositionElement = document.getElementById('selected-seats');
    	 	var seatPosition = seatPositionElement.textContent.split(',').map(position => position.trim());
    	 	var elementSeats = document.getElementById("seats");
    	 	
    	 	var totalPriceFood = document.getElementById('totalPriceFood').textContent;
    	 	var seatPrice = document.getElementById('seat-price').textContent;
    	 	var totalAmount1 = document.getElementById('toTalPayNoFormat1').textContent;
    	 	var suatChieu = document.getElementById("suatChieu").textContent;
            var ngayChieu = document.getElementById("ngayChieu").textContent;
    	 	var listGhe = /*[[${listGhe}]]*/ [];
    	 	var ghetrungkhop = listGhe.filter(item => seatPosition.includes(item.tenghe));
    	 	
    	 	if (ghetrungkhop.length > 0) {
    	 	  //console.log('Các ghế  trùng khớp với vị trí ghế', seatPosition, ':');
    	 	  seatPosition.forEach(position => {
    	 	  //console.log('Vị trí ghế:', position);
				
    	 	    // Thực hiện xử lý cho từng vị trí ghế
    	 	    var gheTrungKhop = ghetrungkhop.find(item => item.tenghe === position);
    	 	    if (gheTrungKhop) {
    	 	      // Thực hiện xử lý cho từng ghế trùng khớp
    	 	     fetch(`/rest/ghe/${gheTrungKhop.maghe}`, {
    	 	        method: 'PUT',
    	 	        headers: {
    	 	          'Content-Type': 'application/json'
    	 	        },
					body: JSON.stringify({maghe: gheTrungKhop.maghe,
					    	 	        	tenghe: gheTrungKhop.tenghe,
					    	 	        	loaighe: gheTrungKhop.loaighe.maloai,
					    	 	        	room: gheTrungKhop.room.mapc,
					    	 	        	hang: gheTrungKhop.hang,
					    	 	        	cot: gheTrungKhop.cot,
					    	 	        	trangthai: true})
    	 	      })
    	 	      .then(response => {
    	 	        if (response.ok) {
    	 	          // Xử lý khi cập nhật trạng thái ghế thành công
    	 	          console.log(`Seat ${gheTrungKhop.maghe} updated successfully.`);
    	 	         var selectedSeatElements = document.querySelectorAll('.selected');
    	 	        if (gheTrungKhop.trangthai === true) {
    	 	        	  // Change the color of the selected seat element
    	 	        	  var selectedSeatElement = document.querySelector('.selected[data-id="' + gheTrungKhop.maghe + '"]');
    	 	        	 	selectedSeatElement.style.color = 'white';
    	                    selectedSeatElement.style.backgroundColor = '#BB0000';
    	                    selectedSeatElement.removeEventListener('click', selectSeat);
    	                    console.log("Chức mừng đã bán");
    	 	        	}
    	 	        } else {
    	 	          // Xử lý khi có lỗi cập nhật trạng thái ghế
    	 	          console.error(`Error updating seat ${gheTrungKhop.maghe}.`);
    	 	        }
    	 	      })
    	 	      .catch(error => {
    	 	        // Xử lý khi có lỗi kết nối hoặc lỗi xử lý
    	 	        console.error(`Error updating seat ${gheTrungKhop.maghe}:`, error);
    	 	      });
    	 	    } else {
    	 	      console.log('Không tìm thấy ghế trùng khớp với vị trí ghế', position);
    	 	    }
    	 		// Store selected seat positions in local storage
    	 	   	var seatCodes = ghetrungkhop.map(item => item.maghe);
    	 	  	localStorage.setItem('selectedSeats', JSON.stringify(seatCodes));
    	 	  
    	 	  
    	 	 const bookingInfo = {
    	            	taikhoan: username,
    	            	lich: lichSTT,
    	            	giamgia: discount,
    	            	ghe: seatPositionElement.textContent,
    	            	soluong: totalSeat,
    	            	tenphim: movieName,
    	            	giobatdau: timeMovie,
    	            	ngaychieu: dateMovie,
    	            	tenpc: room,
    	            	thanhtien: totalAmount,
    	            	combo: nameFood,
    	            	hinh: imageMovie,
    	            	khuyenmai: iddiscount,
    	            	trangthai: true
    	            };
    	            sessionStorage.setItem('bookingInformation', JSON.stringify(bookingInfo));
    	            console.log(bookingInfo.ghe);
    	            
    	            fetch(`/rest/ghe/checkstatus/${seatCodes}`)
    	            .then(resp =>{
    	            	if(resp.ok){
    	            		return resp.json();	
    	            	}else{
    	            		console.log("ERROR SEARCHING FOR SEAT STATUS");
    	            	}
    	            }).then(i =>{
    	            	if(i.trangthai === true){
    	            		Swal.fire({
    	            	          icon: 'warning',
    	            	          title: 'Ghế đã được đặt',
    	            	          text: `Ghế ${gheTrungKhop.tenghe} đã có người đặt rồi. Vui lòng chọn ghế khác.`,
    	            	          timer: 3000,
    	            	          timerProgressBar: true,
    	            	          toast: true,
    	            	          position: 'top-end',
    	            	          showConfirmButton: false,
    	            	          didOpen: (toast) => {
    	            	            toast.addEventListener('mouseenter', Swal.stopTimer);
    	            	            toast.addEventListener('mouseleave', Swal.resumeTimer);
    	            	          }
    	            	        }).then(()=>{
    	            	        	window.location.href = '/home/index' ;
    	            	        });
    	            		return;
    	            	}else{
    	            		// Gọi API đặt vé
    	                    fetch('/rest/ve', {
    	                        method: 'POST',
    	                        headers: {
    	                            'Content-Type': 'application/json'
    	                        },
    	                        body: JSON.stringify(bookingInfo)
    	        			})
    	                    .then(response => {
    	                        if (response.ok) {
    	                            console.log('Booking created successfully.');
    	        					console.log(bookingInfo);
    	        					return response.json();
    	                        } else {
    	                            console.error('Error creating booking.');
    	                            // Xử lý khi có lỗi đặt vé
    	                        }
    	                    })
    	                    .then(data => {
    	        			    // Truy cập giá trị mã vé từ đối tượng JSON
    	        			   const ticketCode = data.mave;
    	        			    console.log('Ticket code:', ticketCode);
    	        			   // Xử lý khi đặt vé thành công
    	        			   Swal.fire({
    	        		            icon: 'success',
    	        		            title: 'Đặt vé thành công',
    	        		            timer: 2000,
    	        		            timerProgressBar: true,
    	        		            toast: true,
    	        		            position: 'top-end',
    	        		            showConfirmButton: false,
    	        		            didOpen: (toast) => {
    	        		                toast.addEventListener('mouseenter', Swal.stopTimer);
    	        		                toast.addEventListener('mouseleave', Swal.resumeTimer);
    	        		            }
    	        		        }).then(() => {
    	        		            // Redirect to the home page
    	        		            window.location.href = '/home/booking/SendBill/'+username+'/'+movieName+'/'+suatChieu+'/'+ngayChieu+'/'+seatPositionElement.textContent+'/'+totalSeat+'/'+seatPrice+'/'+room+'/'+totalPriceFood+'/'+discount+'/'+totalAmount1+'/'+ticketCode // Replace '/home' with the actual URL of your home page
    	        		        });
    	        			})
    	                    .catch(error => {
    	                        console.error('Error creating booking:', error);
    	                        // Xử lý khi có lỗi kết nối hoặc lỗi xử lý
    	                    });
    	            		
    	            	}
    	            })
    	            .catch(error => {
    	                console.error('Error searching for seat status:', error);
    	              });
    	 	 });
    	 	} else {
    	 	  console.log('Không tìm thấy ghế nào trùng khớp với vị trí ghế', seatPosition);
    	 	}
    	 	
            
            
         
        }
     
        function getBookingInformation() {
            const bookingInfo = sessionStorage.getItem('bookingInformation');
            return bookingInfo ? JSON.parse(bookingInfo) : null;
        }


        /* đếm thời gian */
        var countPage = 0;
        let remainingTime = 20 * 60 + 59; // Tổng thời gian còn lại trong giây
        function countdown() {
            const countdownElement = document.getElementById('countdown');
            const countdownElement2 = document.getElementById('countdown2');

            // Kiểm tra xem đã đạt được thời gian đích đến chưa
            if (remainingTime <= 0) {
                clearInterval(timer);
                countdownElement.textContent = 'Count Down 00:00';
                countdownElement2.textContent = '00:00';
                window.location.href = "/home/film"
                countPage = 0;
                return;
            }

            // Chuyển đổi thời gian còn lại thành giờ, phút, giây
            const minutes = Math.floor(remainingTime / 60);
            const seconds = remainingTime % 60;

            // Hiển thị kết quả
            countdownElement.textContent = `Count Down: ${minutes} phút, ${seconds} giây`;
            countdownElement2.textContent = `${minutes} phút, ${seconds} giây`;

            // Giảm thời gian còn lại
            remainingTime--;
        }

        // Cập nhật đồng hồ đếm ngược mỗi giây
        const timer = setInterval(countdown, 1000);
        countdown()


        // chuyển hướng khi đặt xong ghế
        document.getElementById("displaySeat").style.display = "block";
        document.getElementById("displayFood").style.display = "none";
        document.getElementById("displayPay").style.display = "none";

        var nextButton = document.getElementById("nextButton");
        var prevButton = document.getElementById("prevButton");

        nextButton.addEventListener("click", function () {
            if (selectedSeats.length > 0) {
                document.getElementById("displaySeat").style.display = "none";
                document.getElementById("displayFood").style.display = "block";
                document.getElementById("displayPay").style.display = "none";
                countPage++;
            } else {
                alert("bạn chưa chọn bất kỳ ghế nào vui lòng chọn ghế")
}
            if (countPage > 1) {
                document.getElementById("displaySeat").style.display = "none";
                document.getElementById("displayFood").style.display = "none";
                document.getElementById("displayPay").style.display = "block";
                document.getElementById("headMenu").style.display = "none";
                document.getElementById("DieuHuong").style.display = "none";
                updatePay();
                updateSelectedSeats();
            }
        });

        prevButton.addEventListener("click", function () {
            if (countPage == 1) {
                document.getElementById("displaySeat").style.display = "block"
                document.getElementById("displayFood").style.display = "none"
                document.getElementById("displayPay").style.display = "none";
                document.getElementById("headMenu").style.display = "block";
                countPage = 0;
            } else if (countPage > 1) {
                document.getElementById("displaySeat").style.display = "none"
                document.getElementById("displayFood").style.display = "block"
                document.getElementById("displayPay").style.display = "none";
                document.getElementById("headMenu").style.display = "block";
                countPage = 1;
            }
        })
        
        var backButton = document.getElementById("backButton");
        backButton.addEventListener("click", function () {
        	countPage = 0;
        	document.getElementById("headMenu").style.removeProperty("display");
        	document.getElementById("DieuHuong").style.removeProperty("display");
        	document.getElementById("displaySeat").style.display = "block";
            document.getElementById("displayFood").style.display = "none";
            document.getElementById("displayPay").style.display = "none";
        })
        
        
        	/* update Food */
			let itemNameFood = document.getElementById("Food");
        	let total
			function updatePay() {
	            let index = 0;
	            let itemTotalQuantity = 0;
	            /* let filteredItems = itemsArray.filter(item => item.quantity > 0); */
	            itemsArray.map(item => {
				  if (item.quantity > 0) {
					  index++;
					  let itemName = item.name;
					  let itemQuantity = item.quantity;
					  itemTotalQuantity += item.totalQuantity; 
					  
					  const nameFood = document.createElement('div');
					  nameFood.setAttribute('id',`food-${index++}`)
					  nameFood.innerText = `* ${itemName} x ${itemQuantity}`;
					  itemNameFood.appendChild(nameFood)
				}
				  
				});
				let totalFood = document.getElementById("totalPriceFood").textContent = `${formatNumber(itemTotalQuantity)} VND`
        	}
			
        
        /* 2 */
          document.addEventListener('DOMContentLoaded', function () {
		  const decreaseQuantityButtons = document.querySelectorAll('.decrease-quantity');
 		  const increaseQuantityButtons = document.querySelectorAll('.increase-quantity');
 		  const quantityInputs = document.querySelectorAll('.quantity');
 		  let totalPrice = 0;

 		  //Xử lý khi người dùng giảm số lượng
 		  decreaseQuantityButtons.forEach(function (button, index) {
 		    button.addEventListener('click', function () {
 		      if (quantityInputs[index].value > 0) {
 		        quantityInputs[index].value--;
 		        updateCart(index);
 		      }
 		    });
 		  });

		   // Xử lý khi người dùng tăng số lượng
		   increaseQuantityButtons.forEach(function (button, index) {
		     button.addEventListener('click', function () {
		       quantityInputs[index].value++;
		       updateCart(index);
		     });
		   });

		   // Cập nhật giỏ hàng và tổng cộng
		   function updateCart(index) {
		     const quantity = parseInt(quantityInputs[index].value);
		     const priceElement = document.querySelectorAll('.price')[index];
		     const price = parseInt(priceElement.innerText.split(':')[1].trim().replace(' VND', ''));
		     const itemName = document.querySelectorAll('h5')[index].innerText;
		
		  // Tìm vị trí của phần tử đã tồn tại trong mảng
		     const existingItemIndex = itemsArray.findIndex(item => item.name === itemName);
		     if (existingItemIndex !== -1) {
		       // Xóa phần tử tại vị trí đã tìm thấy
		       const existingItem = itemsArray[existingItemIndex];
		
		       
		       totalPrice -= existingItem.totalQuantity;
		       itemsArray.splice(existingItemIndex, 1); // Xóa phần tử
		       // Cập nhật thông tin cho phần tử mới
		       const newItem = {
		         name: itemName,
		         quantity: quantity,
		         totalQuantity: price * quantity
		       };
		       itemsArray.push(newItem);
		       console.log(existingItem)
		       if (existingItem === 0) {
		    	   itemsArray.splice(existingItemIndex, 1);
			   }// Thêm phần tử mới vào mảng
		     } else {
		       // Tạo phần tử mới trong mảng
		       const newItem = {
		         name: itemName,
		         quantity: quantity,
		         totalQuantity: price * quantity
		       };
		       itemsArray.push(newItem);
		     }
			
			
		     // Cập nhật tổng cộng
		     totalPrice = itemsArray.reduce((total, item) => total + item.totalQuantity, 0);
		     combo = totalPrice
		     
		     console.log("danh sách",itemsArray)
		     // Gọi hàm để lấy thông tin đồ ăn từ mảng
		     updateSelectedSeats()
		   }
		
		   // Hàm lấy thông tin đồ ăn từ mảng
		   function getItemsArray() {
		     console.log(itemsArray); // In mảng thông tin đồ ăn ra ngoài
		   }
 		});
        
         
        function formatCurrency(value) {
		    const formatter = new Intl.NumberFormat('vi-VN', {
			       	style: 'currency',
			        currency: 'VND',
			        minimumFractionDigits: 0,
		       	});
			return formatter.format(value);
       	}
        
        function toggleSeatStatus() {
            const lockButton = document.getElementById('lockButton');
            const seats = document.getElementsByClassName('seat');
            var elementSeats = document.getElementById("seats");
            lockButton.addEventListener('click', () => {
              Array.from(seats).forEach(seat => {
                if (seat.classList.contains('selected')) {
                  if (!seat.classList.contains('sold')) {
                    seat.classList.add('sold');
                    seat.style.color = 'white';
                    if(elementSeats){
	                    var idGhe = seat.getAttribute('data-id');
	            	 	console.log(idGhe);
                    }
                    console.log("Chức mừng đã bán");
                    seat.style.backgroundColor = '#BB0000';
                    seat.removeEventListener('click', selectSeat);
                  } else {
                    seat.classList.remove('sold');
                    seat.style.color = 'black';
                    console.log("Xui quá bán không được");
                    seat.style.backgroundColor = '';
                    seat.addEventListener('click', selectSeat);
                  }
                }
              });
            });
          }
        toggleSeatStatus();

        
     // Retrieve selected seat positions from local storage
       window.addEventListener('load', function() {
		  var seatElements = document.getElementsByClassName('seat'); // Lấy tất cả class có tên seat
		  var ma_phong = document.getElementById("mapc").textContent;
		  // GET tất cả ghế bằng API
		  fetch('/rest/ghe') 
		    .then(response => response.json()) //Chuyển đổi thành JSON
		    .then(seats => {
		    	var soldSeatsCount = 0; // Số ghế đã bán
		      // Lặp trong JSON để lấy trạng thái của seat từ database
		    	seats.forEach(seat => {
		            if (seat.trangthai === true && seat.room.mapc === ma_phong) {
		              var selectedSeatElement = document.querySelector('.seat[data-id="' + seat.maghe + '"]');
		              if (selectedSeatElement) {
		                selectedSeatElement.classList.add('sold');
		                selectedSeatElement.style.color = 'white';
		                selectedSeatElement.style.backgroundColor = '#BB0000';
		                selectedSeatElement.removeEventListener('click', selectSeat);
		              	soldSeatsCount++;
		              }
		            }
		          });
		          var remainingSeatsCount = seatElements.length - soldSeatsCount;
		          var totalSeatsElement = document.getElementById('TotalSeat2');
		          totalSeatsElement.textContent = `Số ghế ${remainingSeatsCount}/${seatElements.length}`;
		    })
		    .catch(error => {
		      console.error('Lỗi khi lấy thông tin ghế:', error);
		    });
		});
    </script>

	<!-- Pay -->
	<script>
		function getSelectedRadioValue() {
			  var options = document.getElementsByName("flexRadioDefault");
			  let check = "";
			  for (var i = 0; i < options.length; i++) {
			    if (options[i].checked) {
			      check = options[i].value;
			    }
			  }
			  
			  if (check === "vnpay") {
				window.location.href="/home/booking/ticket/pay/"+ totalPay
			  }else if(check.trim() === ""){
				  this.saveBookingInformation();
			  }
		}
	</script>

	<script type="text/javascript">
		//phương thức lấy tên tk
		function getCookieValue(cookieName) {
			  var name = cookieName + "=";
			  var decodedCookie = decodeURIComponent(document.cookie);
			  var cookieArray = decodedCookie.split(";");

			  for (var i = 0; i < cookieArray.length; i++) {
			    var cookie = cookieArray[i];
			    while (cookie.charAt(0) == " ") {
			      cookie = cookie.substring(1);
			    }
			    if (cookie.indexOf(name) == 0) {
			      return cookie.substring(name.length, cookie.length);
			    }
			  }
			  return null;
			}
	</script>

	<!-- bootsstrap JS -->
	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"
		integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4"
		crossorigin="anonymous"></script>
	<script src="/assets/statics/script.js"></script>

	<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
	<script>
        AOS.init();
    </script>


</body>

</html>